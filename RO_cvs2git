#!/bin/bash

# Copyright 2018 Timothy Baldwin
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -e -o pipefail
cd "$(dirname "$0")"
unset $(compgen -v GIT)
mkdir -p git split cvsroot/CVSROOT

bwrap=(bwrap --unsetenv TMPDIR --cap-drop ALL --die-with-parent --unshare-all --proc /proc --dev /dev --dir /tmp )

make -f sandbox.mk

for i in /etc/alternatives /usr /bin /sbin /lib*
do
  if [[ -L $i ]]; then
    bwrap+=(--symlink "$(readlink "$i")" "$i")
  else
    bwrap+=(--ro-bind "$i" "$i")
  fi
done

prepare_git() {
  mkdir -p "$1"
  cd "$1"
  ! rm -rf .git
  git init .
  echo "ref: refs/heads/$2_master" > .git/HEAD
}

convert2() {
  set -e -o pipefail
  /cvs2svn/cvs2git "/home/rool/rab/cvsroot/$0" --encoding=cp437 --tmpdir /tmp/tmp --blobfile /tmp/blob --dumpfile /tmp/dump --username=cvs2git >&2
  cat /tmp/blob
  sed /tmp/dump -E -e "s:refs/(heads|tags)/:refs/original/\\1/$1_:g"
}

convert() {
  set -e -o pipefail
  echo Processing ${1}...
  prefix="${1//\//_}"
  exec > >(tee "/split/${prefix}_log")
  exec 2>&1
  echo
  echo Processing ${1}...
  if [[ -v split ]]; then
    prepare_git "/split/${prefix}" "${prefix}"
  fi
  bwrap --unshare-all --ro-bind / / --tmpfs /home/rool/rab/cvsroot/CVSROOT --die-with-parent --proc /proc --dev /dev --tmpfs /tmp \
  bash -c 'convert2 "$@"' "$1" "${prefix}" | git fast-import

  if [[ -v split ]]; then
    python3 /fixup.py
  fi
  echo ${1} Processed
}



process() {

  bwrap --unshare-all --ro-bind / / --bind /home/rool/rab/cvsroot/CVSROOT /home/rool/rab/cvsroot/CVSROOT --die-with-parent --proc /proc --dev /dev --tmpfs /tmp \
  cvs -d /home/rool/rab/cvsroot/CVSROOT init

  if [[ ! -v split ]]; then
    prepare_git git apache_RiscOS_Sources_Kernel
  fi

  (
    cd /home/rool/rab/cvsroot
    perl -ne '/^([a-zA-Z]+[^\s]*)\s/; $_ = $1; tr:.:/:; print "$_\n" if -d $_;' Products/*/modules,v
    printf "%s\n" Products/*
  ) | sort -u | parallel convert

  if [[ ! -v split ]]; then
    python3 /fixup.py
  fi

}

export -f convert convert2 prepare_git process

"${bwrap[@]}"  --seccomp 9 9<seccomp --ro-bind cvsroot /home/rool/rab/cvsroot  --tmpfs /home/rool/rab/cvsroot/CVSROOT --bind git /git --bind split /split --ro-bind fixup.py /fixup.py --ro-bind cvs2svn /cvs2svn --chdir / bash -c process
